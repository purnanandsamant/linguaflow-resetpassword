<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - LinguaFlow</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        h1 {
            margin-top: 0;
            color: #FFDD00;
        }
        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 16px;
            box-sizing: border-box;
        }
        .btn {
            background-color: #FFDD00;
            color: #000;
            border: none;
            border-radius: 5px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
        }
        .error {
            color: #ff5252;
            margin-top: 10px;
            text-align: center;
        }
        .success {
            color: #4CAF50;
            margin-top: 10px;
            text-align: center;
        }
        .debug {
            color: #888;
            margin-top: 10px;
            text-align: left;
            font-size: 12px;
            word-break: break-all;
            max-height: 100px;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            padding: 5px;
            margin-top: 20px;
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #FFDD00;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Reset Your Password</h1>
        <div id="loading" class="loader"></div>
        <div id="error" class="error"></div>
        <div id="success" class="success"></div>
        
        <div id="resetForm">
            <div class="input-group">
                <label for="password">New Password</label>
                <input type="password" id="password" placeholder="Enter your new password" />
            </div>
            <div class="input-group">
                <label for="confirmPassword">Confirm Password</label>
                <input type="password" id="confirmPassword" placeholder="Confirm your new password" />
            </div>
            <button class="btn" onclick="resetPassword()">Reset Password</button>
        </div>
        
        <div id="debugInfo" class="debug"></div>
    </div>

    <script>
        // Initialize Supabase client
        const SUPABASE_URL = 'https://bzagepvymwyxvohfkzob.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6YWdlcHZ5bXd5eHZvaGZrem9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE2NzAwMjk4NzUsImV4cCI6MTk4NTYwNTg3NX0.SZHqIWKbpDev_QPT2jGiWUqTpBYUqEA7gaI6J2M34cI';
        
        // Create the Supabase client correctly
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Debug function to display info
        function debugLog(message) {
            console.log(message);
            const debugElement = document.getElementById('debugInfo');
            debugElement.innerHTML += message + '<br>';
        }

        // DISPLAY ENTIRE URL FOR DEBUGGING
        debugLog('Full URL: ' + window.location.href);
        debugLog('Hash: ' + window.location.hash);
        debugLog('Search: ' + window.location.search);
        
        // Try to parse any token from ANY part of the URL
        function getAllPossibleTokens() {
            const result = {
                hashParams: new URLSearchParams(window.location.hash.substring(1)),
                searchParams: new URLSearchParams(window.location.search),
                rawUrl: window.location.href,
                possibleTokens: []
            };
            
            // Check for tokens in hash
            if (result.hashParams.has('access_token')) {
                result.possibleTokens.push({
                    type: 'access_token',
                    source: 'hash',
                    value: result.hashParams.get('access_token')
                });
            }
            
            if (result.hashParams.has('token')) {
                result.possibleTokens.push({
                    type: 'token',
                    source: 'hash',
                    value: result.hashParams.get('token')
                });
            }
            
            // Check for tokens in search params
            if (result.searchParams.has('access_token')) {
                result.possibleTokens.push({
                    type: 'access_token',
                    source: 'search',
                    value: result.searchParams.get('access_token')
                });
            }
            
            if (result.searchParams.has('token')) {
                result.possibleTokens.push({
                    type: 'token',
                    source: 'search',
                    value: result.searchParams.get('token')
                });
            }
            
            // Look for token in full URL string (sometimes it's embedded differently)
            const tokenMatch = result.rawUrl.match(/token=([^&]+)/);
            if (tokenMatch && tokenMatch[1]) {
                result.possibleTokens.push({
                    type: 'token',
                    source: 'raw_url_match',
                    value: tokenMatch[1]
                });
            }
            
            return result;
        }

        // Reset password function
        async function resetPassword() {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorElement = document.getElementById('error');
            const successElement = document.getElementById('success');
            const loadingElement = document.getElementById('loading');
            
            // Reset UI states
            errorElement.textContent = '';
            successElement.textContent = '';
            loadingElement.style.display = 'block';
            
            // Validate inputs
            if (!password) {
                errorElement.textContent = 'Please enter a new password';
                loadingElement.style.display = 'none';
                return;
            }
            
            if (password !== confirmPassword) {
                errorElement.textContent = 'Passwords do not match';
                loadingElement.style.display = 'none';
                return;
            }
            
            if (password.length < 6) {
                errorElement.textContent = 'Password must be at least 6 characters';
                loadingElement.style.display = 'none';
                return;
            }
            
            try {
                // Get all possible tokens and log them for debugging
                const tokenInfo = getAllPossibleTokens();
                debugLog('Found ' + tokenInfo.possibleTokens.length + ' possible tokens');
                tokenInfo.possibleTokens.forEach(token => {
                    debugLog(`Token type: ${token.type}, source: ${token.source}`);
                });
                
                // First, try to directly update password
                debugLog('Attempting direct password update...');
                let result = await supabase.auth.updateUser({ password });
                
                if (result.error) {
                    debugLog('Direct update failed: ' + result.error.message);
                    
                    // If direct update fails, try each token
                    for (const token of tokenInfo.possibleTokens) {
                        debugLog(`Trying with token of type ${token.type} from ${token.source}`);
                        
                        if (token.type === 'access_token') {
                            // Try setting session with access token
                            debugLog('Setting session with access token');
                            const refreshToken = tokenInfo.hashParams.get('refresh_token') || '';
                            
                            const { data: session, error: sessionError } = await supabase.auth.setSession({
                                access_token: token.value,
                                refresh_token: refreshToken
                            });
                            
                            if (sessionError) {
                                debugLog('Session set failed: ' + sessionError.message);
                                continue;
                            }
                            
                            // Try update again
                            result = await supabase.auth.updateUser({ password });
                            if (!result.error) break;
                            debugLog('Update after session set failed: ' + result.error.message);
                        } 
                        else if (token.type === 'token') {
                            // Try with OTP verification
                            debugLog('Verifying with OTP token');
                            const type = tokenInfo.hashParams.get('type') || 
                                        tokenInfo.searchParams.get('type') || 'recovery';
                            
                            const { data: verifyData, error: verifyError } = await supabase.auth.verifyOtp({
                                token_hash: token.value,
                                type: type
                            });
                            
                            if (verifyError) {
                                debugLog('OTP verification failed: ' + verifyError.message);
                                continue;
                            }
                            
                            // Try update again
                            result = await supabase.auth.updateUser({ password });
                            if (!result.error) break;
                            debugLog('Update after OTP verification failed: ' + result.error.message);
                        }
                    }
                }
                
                // If still error, throw it
                if (result.error) {
                    throw new Error(result.error.message);
                }
                
                // Success!
                debugLog('Password update successful!');
                document.getElementById('resetForm').style.display = 'none';
                successElement.textContent = 'Your password has been reset successfully! You can now close this window and return to the app to sign in with your new password.';
                
                // Add a return to app button
                const returnButton = document.createElement('button');
                returnButton.className = 'btn';
                returnButton.textContent = 'Return to App';
                returnButton.onclick = function() {
                    window.location.href = 'languagetranslator23://auth/reset-success';
                };
                successElement.parentNode.appendChild(returnButton);
                
            } catch (error) {
                console.error('Error resetting password:', error);
                errorElement.textContent = error.message || 'An error occurred. Please try again.';
            } finally {
                loadingElement.style.display = 'none';
            }
        }

        // Initialize on page load
        window.onload = function() {
            const tokenInfo = getAllPossibleTokens();
            debugLog('Tokens in URL: ' + tokenInfo.possibleTokens.length);
            
            if (tokenInfo.possibleTokens.length === 0) {
                document.getElementById('resetForm').style.display = 'none';
                document.getElementById('error').textContent = 'No reset token found in URL. This page should be accessed from a password reset link sent to your email.';
            }
        };
    </script>
</body>
</html>
